#!/bin/bash
set -e

python3.7 -m pip install --require-hashes -r requirements.txt --target ./package
python3.7 -m pip install --no-deps --target ./package .
git clone git+https://${GITHUB_TOKEN}@github.com/release-engineering/cdn-definitions-private.git
mv ./cdn-definitions-private/data.yaml ./package/cdn_definitions/data.yaml
cp ./configuration/exodus-lambda-deploy.yaml ./package
envsubst < ./configuration/lambda_config.json > ./package/lambda_config.json
aws cloudformation package \
	--template ./package/exodus-lambda-deploy.yaml \
	--s3-bucket $PROJECT-pipeline-artifacts \
	--output-template-file ./package/exodus-lambda-pkg.yaml
